<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ì£¼ì°¨ ì°¨ëŸ‰ í™•ì¸ê¸° (ëª¨ë°”ì¼ ê¶Œí•œ ê³ ì •íŒ)</title>
<style>
  body { font-family: system-ui, -apple-system, "Noto Sans KR", sans-serif; background:#f7f7fb; padding:20px; text-align:center; }
  h2 { color:#2b4eff; margin-bottom:10px; }
  input { font-size:1.2em; padding:10px; width:200px; margin:10px; border-radius:10px; border:1px solid #ccc; text-align:center; }
  button { font-size:1.05em; padding:10px 18px; border:none; border-radius:10px; background:#2b4eff; color:#fff; margin:4px; }
  button:active { background:#203ad4; }
  #stopBtn { background:#ff5c5c; display:none; }
  table { margin:20px auto; border-collapse:collapse; width:92%; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.08); }
  th, td { border:1px solid #e9ecf1; padding:10px; }
  th { background:#f1f3f6; }
  #status { margin-top:12px; font-weight:600; color:#333; }
  #permInfo { margin-top:6px; color:#555; font-size:.95em; }
</style>
</head>
<body>
  <h2>ğŸ¤ ì£¼ì°¨ ì°¨ëŸ‰ í™•ì¸ê¸°</h2>
  <input id="carInput" placeholder="4ìë¦¬ ë²ˆí˜¸ ì…ë ¥" inputmode="numeric" />
  <button id="searchBtn">ì¡°íšŒ</button>
  <button id="voiceBtn">ğŸ™ï¸ ìŒì„±ìœ¼ë¡œ ì¡°íšŒ (í•œë²ˆë§Œ í—ˆìš©)</button>
  <button id="stopBtn">â–  ì¤‘ì§€</button>

  <div id="status"></div>
  <div id="permInfo"></div>

  <table id="resultTable" style="display:none;">
    <thead>
      <tr><th>ë²ˆí˜¸</th><th>ìƒ‰ìƒ</th><th>ì°¨ì¢…</th><th>ì£¼ì°¨ìŠ¤í‹°ì»¤</th></tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
/* ===== ì°¨ëŸ‰ ë°ì´í„°(ì˜ˆì‹œ) ===== */
const carData = [
  { ë²ˆí˜¸: "0114", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ: "í°ìƒ‰",   ì°¨ì¢…: "ë ˆì´" },
  { ë²ˆí˜¸: "0136", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ: "í°ìƒ‰",   ì°¨ì¢…: "C36 ì•„ìš°ë””" },
  { ë²ˆí˜¸: "0159", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ: "ë² ì´ì§€", ì°¨ì¢…: "ëª¨ë‹" },
  { ë²ˆí˜¸: "0211", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ì—†ìŒ",       ìƒ‰ìƒ: "ê²€ì •ê³„ì—´", ì°¨ì¢…: "í¬ë£¨ì¦ˆ" },
  { ë²ˆí˜¸: "0227", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ: "í°ìƒ‰",   ì°¨ì¢…: "K7" },
  { ë²ˆí˜¸: "0759", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ: "ì²­ìƒ‰ê³„ì—´", ì°¨ì¢…: "ì†Œë‚˜íƒ€" },
  { ë²ˆí˜¸: "0841", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ: "í°ìƒ‰",   ì°¨ì¢…: "ì•„ì´ì˜¤ë‹‰" },
  { ë²ˆí˜¸: "1045", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ: "ê²€ì •ê³„ì—´", ì°¨ì¢…: "G90" }
];

/* ===== UI ì—˜ë¦¬ë¨¼íŠ¸ ===== */
const inputEl   = document.getElementById("carInput");
const statusEl  = document.getElementById("status");
const permInfo  = document.getElementById("permInfo");
const table     = document.getElementById("resultTable");
const tbody     = table.querySelector("tbody");
const voiceBtn  = document.getElementById("voiceBtn");
const stopBtn   = document.getElementById("stopBtn");
const searchBtn = document.getElementById("searchBtn");

/* ===== ì „ì—­ ìƒíƒœ ===== */
let recognition = null;
let micStream   = null;
let audioCtx    = null;
let wakeLock    = null;
let isListening = false;
let autoStopTimer = null; // 30ë¶„ íƒ€ì´ë¨¸
let restarting = false;   // onend ë£¨í”„ ì¤‘ë³µ ë°©ì§€

/* ===== ìœ í‹¸ ===== */
function speak(text) {
  if (!("speechSynthesis" in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "ko-KR";
  window.speechSynthesis.speak(u);
}

function showResult(row) {
  tbody.innerHTML = `<tr>
    <td>${row.ë²ˆí˜¸}</td>
    <td>${row.ìƒ‰ìƒ}</td>
    <td>${row.ì°¨ì¢…}</td>
    <td>${row.ì£¼ì°¨ìŠ¤í‹°ì»¤}</td>
  </tr>`;
  table.style.display = "table";
  statusEl.textContent = "âœ… ì°¨ëŸ‰ ì •ë³´ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.";
}

function checkCar() {
  const num = (inputEl.value || "").replace(/\D/g, "").slice(-4).padStart(4, "0");
  if (!num) { speak("ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë§ì”€í•´ì£¼ì„¸ìš”."); return; }
  const found = carData.find(c => c.ë²ˆí˜¸ === num);
  if (found) {
    showResult(found);
    speak(`${num}ë²ˆ ì°¨ëŸ‰ì€ ${found.ìƒ‰ìƒ} ${found.ì°¨ì¢…}, ì£¼ì°¨ìŠ¤í‹°ì»¤ ${found.ì£¼ì°¨ìŠ¤í‹°ì»¤} ì…ë‹ˆë‹¤.`);
  } else {
    table.style.display = "none";
    statusEl.textContent = `ğŸš« ${num}ë²ˆ ì°¨ëŸ‰ì€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`;
    speak(`${num}ë²ˆ ì°¨ëŸ‰ì€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`);
  }
}

/* ===== ê¶Œí•œ & ìŠ¤íŠ¸ë¦¼ ìœ ì§€ ë¡œì§ ===== */
// ë§ˆì´í¬ ê¶Œí•œ ìƒíƒœ í™•ì¸
async function getMicPermissionState() {
  if (!navigator.permissions || !navigator.permissions.query) return null;
  try {
    const res = await navigator.permissions.query({ name: "microphone" });
    return res.state; // "granted" | "prompt" | "denied"
  } catch { return null; }
}

// ìŠ¤íŠ¸ë¦¼ì„ í•œ ë²ˆë§Œ ì—´ê³  30ë¶„ê°„ ìœ ì§€ (íŒì—… ì¬ë“±ì¥ ë°©ì§€)
async function ensureMicStreamOnce() {
  if (micStream) return micStream;

  // ì´ë¯¸ ê¶Œí•œì´ grantë©´ getUserMediaë¥¼ í•œ ë²ˆë§Œ í˜¸ì¶œ
  const state = await getMicPermissionState();
  if (state === "denied") {
    permInfo.textContent = "â›” ë§ˆì´í¬ ê¶Œí•œì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©ìœ¼ë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”.";
    throw new Error("mic denied");
  }

  // ì—¬ê¸°ì„œ ìµœì´ˆ 1íšŒë§Œ getUserMedia í˜¸ì¶œ
  micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  permInfo.textContent = "ğŸ”“ ë§ˆì´í¬ ê¶Œí•œ í—ˆìš©ë¨ â€” 30ë¶„ê°„ ì¶”ê°€ íŒì—… ì—†ì´ ì‚¬ìš©í•©ë‹ˆë‹¤.";
  keepAliveWithWebAudio(micStream);
  tryRequestWakeLock();
  return micStream;
}

// WebAudioë¡œ ìŠ¤íŠ¸ë¦¼ keep-alive (ë³¼ë¥¨ 0ìœ¼ë¡œ ì—°ê²°)
function keepAliveWithWebAudio(stream) {
  if (audioCtx) return;
  try {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const src = audioCtx.createMediaStreamSource(stream);
    const gain = audioCtx.createGain();
    gain.gain.value = 0.0; // ë¬´ìŒ
    src.connect(gain).connect(audioCtx.destination);

    // ì¼ë¶€ ë¸Œë¼ìš°ì €ëŠ” ì¼ì‹œì •ì§€ë  ìˆ˜ ìˆì–´ ì£¼ê¸°ì ìœ¼ë¡œ resume
    const resumeTick = () => {
      if (!audioCtx) return;
      if (audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
      setTimeout(resumeTick, 15000);
    };
    resumeTick();
  } catch (e) {
    // WebAudio ë¯¸ì§€ì›ì´ë©´ íŒ¨ìŠ¤
  }
}

// í™”ë©´ êº¼ì§ ë°©ì§€(Wake Lock)
async function tryRequestWakeLock() {
  if (!("wakeLock" in navigator)) return;
  try {
    wakeLock = await navigator.wakeLock.request("screen");
    document.addEventListener("visibilitychange", async () => {
      if (document.visibilityState === "visible" && !wakeLock) {
        try { wakeLock = await navigator.wakeLock.request("screen"); } catch {}
      }
    });
  } catch {}
}
function releaseWakeLock() {
  try { if (wakeLock) { wakeLock.release(); wakeLock = null; } } catch {}
}

/* ===== ìŒì„± ì¸ì‹ ===== */
function initRecognition() {
  if (!("webkitSpeechRecognition" in window)) {
    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chrome ê¶Œì¥.");
    return;
  }
  if (recognition) return;

  recognition = new webkitSpeechRecognition();
  recognition.lang = "ko-KR";
  recognition.continuous = true;
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onstart = () => {
    isListening = true;
    statusEl.textContent = "ğŸ¤ ë“£ëŠ” ì¤‘ â€” ë²ˆí˜¸ë¥¼ ë§ì”€í•´ì£¼ì„¸ìš”â€¦";
    voiceBtn.style.display = "none";
    stopBtn.style.display = "inline-block";
  };

  recognition.onresult = (e) => {
    const transcript = e.results[e.results.length - 1][0].transcript || "";
    const num = transcript.replace(/[^0-9]/g, "");
    if (num.length >= 2 && num.length <= 4) {
      inputEl.value = num.slice(-4);
      checkCar();
    } else {
      statusEl.textContent = `âš ï¸ "${transcript}"ì—ì„œ ë²ˆí˜¸ë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš”. ë‹¤ì‹œ ë§ì”€í•´ì£¼ì„¸ìš”.`;
    }
  };

  recognition.onerror = (e) => {
    if (e.error === "no-speech") {
      statusEl.textContent = "âŒ ìŒì„±ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê³„ì† ëŒ€ê¸°í•©ë‹ˆë‹¤.";
    } else {
      statusEl.textContent = `âš ï¸ ì˜¤ë¥˜: ${e.error}`;
    }
  };

  recognition.onend = async () => {
    isListening = false;
    // ìë™ ì¬ì‹œì‘ (ê¶Œí•œ íŒì—… ë°©ì§€: getUserMedia ì¬í˜¸ì¶œ ê¸ˆì§€)
    if (autoStopTimer && !restarting) {
      restarting = true;
      try {
        // ìŠ¤íŠ¸ë¦¼ì´ ì‚´ì•„ìˆìœ¼ë©´ ë°”ë¡œ ì¬ì‹œì‘
        if (micStream) recognition.start();
      } catch {
        // ì‚¬ìš©ì ë™ì‘ í•„ìš”í•  ìˆ˜ ìˆìŒ
        statusEl.textContent = "â¸ ìŒì„±ì¸ì‹ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œì‘ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
        voiceBtn.style.display = "inline-block";
        stopBtn.style.display = "none";
      } finally {
        setTimeout(() => { restarting = false; }, 300);
      }
    } else {
      voiceBtn.style.display = "inline-block";
      stopBtn.style.display = "none";
    }
  };
}

async function startVoice() {
  // 1) ìµœì´ˆ 1íšŒ ê¶Œí•œ ìš”ì²­(ì´ë¯¸ grantedë©´ íŒì—… ì—†ìŒ) â†’ 2) ì¸ì‹ ì‹œì‘ â†’ 3) 30ë¶„ íƒ€ì´ë¨¸
  try {
    await ensureMicStreamOnce();  // ì—¬ê¸°ì„œë§Œ getUserMedia í˜¸ì¶œ
    initRecognition();
    try { recognition.start(); } catch {}
    if (autoStopTimer) clearTimeout(autoStopTimer);
    autoStopTimer = setTimeout(() => stopVoice(true), 30 * 60 * 1000);
  } catch (err) {
    console.warn(err);
  }
}

function stopVoice(isAuto=false) {
  // ì¸ì‹ ì •ë¦¬
  if (recognition) {
    try { recognition.onend = null; recognition.stop(); } catch {}
    recognition = null;
  }
  // ë§ˆì´í¬/ì˜¤ë””ì˜¤ ì •ë¦¬ (ì‚¬ìš©ì ìš”ì²­ ë˜ëŠ” 30ë¶„ ìë™ì¢…ë£Œì‹œì—ë§Œ)
  if (micStream) {
    micStream.getTracks().forEach(t => t.stop());
    micStream = null;
  }
  if (audioCtx) {
    try { audioCtx.close(); } catch {}
    audioCtx = null;
  }
  releaseWakeLock();
  if (autoStopTimer) { clearTimeout(autoStopTimer); autoStopTimer = null; }

  isListening = false;
  statusEl.textContent = isAuto ? "â° 30ë¶„ì´ ì§€ë‚˜ ìë™ìœ¼ë¡œ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤." : "â¸ ìŒì„±ì¸ì‹ì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.";
  permInfo.textContent = "ğŸ”’ ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‚¬ìš©í•˜ë ¤ë©´ ì‹œì‘ì„ ëˆ„ë¥´ì„¸ìš”.";
  voiceBtn.style.display = "inline-block";
  stopBtn.style.display = "none";
}

/* ===== ì´ë²¤íŠ¸ ë°”ì¸ë”© ===== */
searchBtn.addEventListener("click", checkCar);
voiceBtn.addEventListener("click", startVoice);
stopBtn.addEventListener("click", () => stopVoice(false));

/* iOS/Safari ì•ˆë‚´ (ì§€ì› ì œí•œ) */
(function note() {
  const ua = navigator.userAgent.toLowerCase();
  if (/iphone|ipad|ipod/.test(ua)) {
    permInfo.textContent = "â„¹ï¸ iOS SafariëŠ” Web Speech API ì§€ì›ì´ ì œí•œë˜ì–´ ìë™ ì¬ì‹œì‘/ë°±ê·¸ë¼ìš´ë“œ ë™ì‘ì´ ì œì•½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
  }
})();
</script>
</body>
</html>
