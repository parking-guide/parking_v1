<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì£¼ì°¨ ì°¨ëŸ‰ í™•ì¸ê¸° (Android ìµœì í™” ìŒì„±ì¸ì‹)</title>
<style>
  :root { --primary:#2563eb; --bg:#f8fafc; --text:#0f172a; --muted:#64748b; --card:#ffffff; --bad:#b91c1c; --good:#065f46; --shadow:0 2px 8px rgba(2,6,23,.08); }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Apple SD Gothic Neo","Noto Sans KR",Roboto,Segoe UI,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:20px;line-height:1.5}
  .container{max-width:720px;margin:0 auto}
  h2{color:var(--primary);margin:0 0 12px;font-size:1.6rem}
  .desc{margin:0 0 16px;color:var(--muted);font-size:.95rem}
  .row{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center}
  input[type="text"]{font-size:1.2rem;padding:12px 14px;border-radius:12px;border:1px solid #cbd5e1;background:#fff;width:100%;text-align:center;box-shadow:var(--shadow)}
  button{font-size:.95rem;padding:10px 14px;border:none;background:var(--primary);color:white;border-radius:12px;box-shadow:var(--shadow)}
  button.secondary{background:#0f172a}
  button.ghost{background:#e2e8f0;color:#0f172a}
  .panel{background:var(--card);box-shadow:var(--shadow);border-radius:14px;padding:12px;margin-top:12px}
  .panel h4{margin:8px 0 6px}
  .grid-two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  select,input[type="checkbox"]{width:100%;padding:10px;border-radius:10px;border:1px solid #cbd5e1;background:#fff}
  #status{margin-top:10px;font-weight:700}
  #status.bad{color:var(--bad)}
  #status.good{color:var(--good)}
  table{margin:16px auto 0;border-collapse:collapse;width:100%;background:white;box-shadow:var(--shadow);border-radius:12px;overflow:hidden}
  th,td{border-bottom:1px solid #e2e8f0;padding:10px;text-align:center;font-size:.95rem}
  th{background:#f1f5f9}
  .note{color:var(--muted);font-size:.9rem}
  details{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:10px 12px;margin-top:10px}
  summary{cursor:pointer}
  pre{background:#0b1020;color:#d1e7ff;padding:10px;border-radius:8px;overflow:auto;font-size:12px;max-height:200px}
</style>
</head>
<body>
  <div class="container">
    <h2>ğŸ¤ ì£¼ì°¨ ì°¨ëŸ‰ í™•ì¸ê¸° (Androidìš©)</h2>
    <p class="desc">ì•ˆë“œë¡œì´ë“œ + Chromeì—ì„œ ë™ì‘í•˜ë„ë¡ ìµœì í™”í–ˆìŠµë‹ˆë‹¤. HTTPS ê¶Œì¥, í˜ì´ì§€ ì§„ì… í›„ ë°˜ë“œì‹œ ë²„íŠ¼ì„ í•œë²ˆ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</p>

    <div class="row">
      <input type="text" id="carInput" placeholder="4ìë¦¬ ë²ˆí˜¸ ì…ë ¥" inputmode="numeric" autocomplete="off" />
      <button id="btnCheck">ì¡°íšŒ</button>
      <button id="btnVoice">ğŸ™ï¸ ìŒì„±ì¡°íšŒ(1íšŒ)</button>
    </div>

    <div id="status"></div>

    <table id="resultTable" style="display:none;">
      <thead><tr><th>ë²ˆí˜¸</th><th>ìƒ‰ìƒ</th><th>ì°¨ì¢…</th><th>ì£¼ì°¨ìŠ¤í‹°ì»¤</th></tr></thead>
      <tbody></tbody>
    </table>

    <div class="panel">
      <h4>ğŸ”§ ë§ˆì´í¬/ì¸ì‹ ì˜µì…˜</h4>
      <div class="grid-two">
        <label>
          <span class="note">ì„¸ì…˜ ìœ ì§€ì‹œê°„</span>
          <select id="sessionMinutes">
            <option value="1">1ë¶„</option>
            <option value="5" selected>5ë¶„</option>
            <option value="10">10ë¶„</option>
            <option value="30">30ë¶„</option>
          </select>
        </label>
        <label>
          <span class="note">ìŒì„± ì•ˆë‚´</span>
          <select id="voiceMode">
            <option value="short" selected>ê°„ë‹¨(ë“±ë¡/ë¯¸ë“±ë¡)</option>
            <option value="full">ìƒì„¸(ìƒ‰ìƒ/ì°¨ì¢… í¬í•¨)</option>
          </select>
        </label>
      </div>
      <div class="grid-two" style="margin-top:8px;">
        <label style="display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="autoRestart" checked />
          <span>ìë™ ì¬ì¸ì‹(ì„¸ì…˜ ì¤‘)</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="continuousMode" />
          <span>ì—°ì† ì¸ì‹(Chromeìš©)</span>
        </label>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end;margin-top:8px;">
        <button class="ghost" id="btnEnvCheck">í™˜ê²½ ì ê²€</button>
        <button class="secondary" id="btnStartSession">ì„¸ì…˜ ì‹œì‘</button>
        <button class="ghost" id="btnStopSession">ì„¸ì…˜ ì¢…ë£Œ</button>
      </div>
      <p class="note" id="permHint" style="margin:8px 0 0;"></p>
      <details><summary>ë””ë²„ê·¸ ë¡œê·¸ ë³´ê¸°</summary><pre id="debug"></pre></details>
    </div>
  </div>

<script>
// ===== ìœ í‹¸ =====
function logDebug(...args){ const el=document.getElementById('debug'); el.textContent += args.map(a=>typeof a==='object'?JSON.stringify(a,null,2):String(a)).join(' ') + "\\n"; }

// ===== ì°¨ëŸ‰ ë°ì´í„° =====
const carData = [
  { ë²ˆí˜¸: "0114", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ: "í°ìƒ‰", ì°¨ì¢…: "ë ˆì´ " },
  { ë²ˆí˜¸: "0136", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ: "í°ìƒ‰", ì°¨ì¢…: "C36 ì•„ìš°ë””" },
  { ë²ˆí˜¸: "0159", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ: "ë² ì´ì§€", ì°¨ì¢…: "ëª¨ë‹" },
  { ë²ˆí˜¸: "0211", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ì—†ìŒ", ìƒ‰ìƒ: "ê²€ì •ê³„ì—´", ì°¨ì¢…: "í¬ë£¨ì¦ˆ" },
  { ë²ˆí˜¸: "0212", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ: "ê²€ì •ê³„ì—´", ì°¨ì¢…: "í¬ë£¨ì¦ˆ" },
  { ë²ˆí˜¸: "0227", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ: "í°ìƒ‰", ì°¨ì¢…: "K7" },
  { ë²ˆí˜¸: "0285", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ: "ê²€ì •ê³„ì—´", ì°¨ì¢…: "ì„íŒ”ë¼ì‰ë³´ë ˆ" },
  { ë²ˆí˜¸: "0307", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ: "ê²€ì •ê³„ì—´", ì°¨ì¢…: "ì œë„¤ì‹œìŠ¤" },
  { ë²ˆí˜¸: "0430", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ: "í°ìƒ‰", ì°¨ì¢…: "ì†Œë‚˜íƒ€" },
];

// ===== ìš”ì†Œ =====
const inputEl = document.getElementById("carInput");
const statusEl = document.getElementById("status");
const table = document.getElementById("resultTable");
const tbody = table.querySelector("tbody");
const btnCheck = document.getElementById("btnCheck");
const btnVoice = document.getElementById("btnVoice");
const btnEnvCheck = document.getElementById("btnEnvCheck");
const btnStartSession = document.getElementById("btnStartSession");
const btnStopSession = document.getElementById("btnStopSession");
const sessionMinutesEl = document.getElementById("sessionMinutes");
const voiceModeEl = document.getElementById("voiceMode");
const autoRestartEl = document.getElementById("autoRestart");
const continuousModeEl = document.getElementById("continuousMode");
const permHintEl = document.getElementById("permHint");

let recognition=null, micStream=null, sessionTimer=null, sessionActive=false, restarting=false, wakeLock=null;

// ===== ìŠ¤í”¼ì¹˜(TTS) =====
function speak(text){
  try { const u=new SpeechSynthesisUtterance(text); u.lang="ko-KR"; speechSynthesis.cancel(); speechSynthesis.speak(u); }
  catch(e){ logDebug("TTS ì‹¤íŒ¨", e); }
}

// ===== ê²°ê³¼ í‘œì‹œ =====
function showResult(data){
  tbody.innerHTML = `<tr><td>${data.ë²ˆí˜¸}</td><td>${data.ìƒ‰ìƒ}</td><td>${data.ì°¨ì¢…}</td><td>${data.ì£¼ì°¨ìŠ¤í‹°ì»¤}</td></tr>`;
  table.style.display="table";
  statusEl.textContent="âœ… ì°¨ëŸ‰ ì •ë³´ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤."; statusEl.className="good";
}
function clearResult(msg=""){
  table.style.display="none"; tbody.innerHTML=""; statusEl.textContent=msg; statusEl.className = msg?"bad":"";
}

// ===== ì¡°íšŒ =====
function checkCar(){
  const num = inputEl.value.replace(/\D/g,"").slice(-4).padStart(4,"0");
  if(!num || num==="0000"){ speak("ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë§ì”€í•´ì£¼ì„¸ìš”."); return; }
  const found = carData.find(c=>c.ë²ˆí˜¸===num);
  if(found){
    showResult(found);
    if(voiceModeEl.value==="short") speak(`${num}ë²ˆ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
    else speak(`${num}ë²ˆ ì°¨ëŸ‰ì€ ${found.ìƒ‰ìƒ} ${found.ì°¨ì¢…}, ì£¼ì°¨ìŠ¤í‹°ì»¤ ${found.ì£¼ì°¨ìŠ¤í‹°ì»¤} ì…ë‹ˆë‹¤.`);
  }else{
    clearResult(`ğŸš« ${num}ë²ˆ ì°¨ëŸ‰ì€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`);
    speak(`${num}ë²ˆ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`);
  }
}

// ===== í™˜ê²½ ì ê²€ =====
async function envCheck(){
  const isHttps = location.protocol==="https:";
  const ua = navigator.userAgent;
  const isAndroid = /Android/i.test(ua);
  const isChrome = /Chrome/i.test(ua);
  window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const srSupported = !!window.SpeechRecognition;

  const msg=[
    `í”„ë¡œí† ì½œ: ${location.protocol} (${isHttps ? "âœ… HTTPS ê¶Œì¥" : "âš ï¸ HTTPS ê¶Œì¥"})`,
    `í”Œë«í¼: ${isAndroid?"Android":"ê¸°íƒ€"}`,
    `ë¸Œë¼ìš°ì €: ${isChrome?"Chrome":"ê¸°íƒ€"}`,
    `SpeechRecognition ì§€ì›: ${srSupported ? "âœ… ì§€ì›" : "âŒ ë¯¸ì§€ì›"}`,
    `ì˜¨ë¼ì¸ ìƒíƒœ: ${navigator.onLine ? "ì˜¨ë¼ì¸" : "ì˜¤í”„ë¼ì¸"}`
  ];
  statusEl.textContent = srSupported ? "ìŒì„±ì¸ì‹ ì§€ì› ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤." : "ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
  statusEl.className = srSupported ? "good" : "bad";
  permHintEl.textContent = isHttps ? "HTTPSì—ì„œ ê¶Œí•œ ìœ ì§€ê°€ ë” ì•ˆì •ì ì…ë‹ˆë‹¤." : "ê°€ëŠ¥í•˜ë©´ HTTPSë¡œ ì ‘ì†í•˜ì„¸ìš”.";
  document.getElementById("debug").textContent = msg.join("\n");
}

// ===== Wake Lock (í™”ë©´ êº¼ì§ ë°©ì§€) =====
async function requestWakeLock(){
  try{
    if('wakeLock' in navigator){ wakeLock = await navigator.wakeLock.request('screen'); logDebug("WakeLock íšë“"); }
  }catch(e){ logDebug("WakeLock ì‹¤íŒ¨", e && e.name); }
}

// ===== ì„¸ì…˜ ì»¨íŠ¸ë¡¤ =====
async function startMicSession(){
  if(sessionActive) return;
  window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!window.SpeechRecognition){
    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Android Chromeì—ì„œ ì´ìš©í•´ì£¼ì„¸ìš”.");
    statusEl.className="bad"; statusEl.textContent="âŒ ìŒì„±ì¸ì‹ ë¯¸ì§€ì› ë¸Œë¼ìš°ì €"; return;
  }
  try{
    micStream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true, noiseSuppression:true}});
  }catch(e){
    statusEl.className="bad"; statusEl.textContent="âŒ ë§ˆì´í¬ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”.";
    speak("ë§ˆì´í¬ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤."); logDebug("getUserMedia error:", e && e.name); return;
  }

  sessionActive=true; statusEl.className="good"; statusEl.textContent="ğŸ§ ë§ˆì´í¬ ì„¸ì…˜ ì‹œì‘ë¨. ë²ˆí˜¸ë¥¼ ë§ì”€í•´ì£¼ì„¸ìš”.";
  const minutes = parseInt(sessionMinutesEl.value,10)||5;
  if(sessionTimer) clearTimeout(sessionTimer);
  sessionTimer = setTimeout(()=>{ stopMicSession(); statusEl.textContent="â±ï¸ ì„¸ì…˜ ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."; speak("ì„¸ì…˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); }, minutes*60*1000);

  await requestWakeLock();
  startRecognitionLoop(true);
}

function stopMicSession(){
  sessionActive=false;
  if(sessionTimer){ clearTimeout(sessionTimer); sessionTimer=null; }
  if(recognition){ try{ recognition.onend=null; recognition.stop(); }catch(e){} recognition=null; }
  if(micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream=null; }
  if(wakeLock){ try{ wakeLock.release(); }catch(e){} wakeLock=null; }
  statusEl.textContent="ğŸ›‘ ë§ˆì´í¬ ì„¸ì…˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."; statusEl.className="";
}

function startVoiceOnce(){
  window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!window.SpeechRecognition){ alert("Android Chromeì—ì„œ ì´ìš©í•´ì£¼ì„¸ìš”."); statusEl.className="bad"; statusEl.textContent="âŒ ìŒì„±ì¸ì‹ ë¯¸ì§€ì›"; return; }
  recognition && recognition.stop(); recognition=null;
  createRecognition(); if(!recognition) return;
  try{ recognition.start(); }catch(e){ logDebug("start ì‹¤íŒ¨", e && e.name); }
}

// ì¸ì‹ ë£¨í”„
function startRecognitionLoop(fromGesture=false){
  if(!sessionActive) return;
  if(recognition) return;
  createRecognition(); if(!recognition) return;
  try{ recognition.start(); }catch(e){
    logDebug("loop start ì‹¤íŒ¨", e && e.name);
    if(!fromGesture){ statusEl.className="bad"; statusEl.textContent="ë¸Œë¼ìš°ì € ì •ì±…ìƒ ìë™ ì¬ì‹œì‘ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. 'ì„¸ì…˜ ì‹œì‘'ì„ ë‹¤ì‹œ ëˆ„ë¥´ì„¸ìš”."; }
  }
}

function createRecognition(){
  window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!window.SpeechRecognition) return;
  const r = new window.SpeechRecognition();
  r.lang="ko-KR";
  r.interimResults=false;
  r.maxAlternatives=1;
  r.continuous= !!continuousModeEl.checked; // Chromeì—ì„œëŠ” ì—°ì† ëª¨ë“œê°€ ë” ì˜ ë™ì‘í•  ìˆ˜ ìˆìŒ

  r.onstart = ()=>{ statusEl.textContent="ğŸ™ï¸ ë²ˆí˜¸ë¥¼ ë§ì”€í•´ì£¼ì„¸ìš”..."; };
  r.onresult = (e)=>{
    const transcript = e.results[0][0].transcript || "";
    const num = transcript.replace(/[^0-9]/g,"").slice(-4);
    logDebug("onresult:", transcript, "â†’", num);
    if(num && num.length>=2 && num.length<=4){ inputEl.value=num.padStart(4,"0"); checkCar(); }
    else{ statusEl.className="bad"; statusEl.textContent=`âš ï¸ "${transcript}"ì—ì„œ ë²ˆí˜¸ ì¶”ì¶œ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤.`; speak("ë²ˆí˜¸ë¥¼ ì •í™•íˆ ë§ì”€í•´ì£¼ì„¸ìš”."); }
  };
  r.onend = ()=>{
    if(sessionActive && autoRestartEl.checked && !restarting){
      restarting=true; setTimeout(()=>{ restarting=false; startRecognitionLoop(false); }, 250);
    }else{ recognition=null; }
  };
  r.onerror = (ev)=>{
    const map={
      "not-allowed":"âŒ ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”.",
      "no-speech":"âŒ ìŒì„±ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë§ì”€í•´ì£¼ì„¸ìš”.",
      "network":"âŒ ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.",
      "aborted":"ì¸ì‹ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤.",
      "service-not-allowed":"âŒ ë³´ì•ˆ ë¬¸ì œë¡œ ì„œë¹„ìŠ¤ê°€ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. HTTPS í™˜ê²½ì—ì„œ ì‚¬ìš©í•´ì£¼ì„¸ìš”."
    };
    statusEl.className="bad"; statusEl.textContent=map[ev.error]||(`âŒ ì˜¤ë¥˜: ${ev.error}`);
    logDebug("onerror:", ev.error);
    if(sessionActive && autoRestartEl.checked) setTimeout(()=>startRecognitionLoop(false), 600);
    else recognition=null;
  };
  recognition=r;
}

// ===== ì´ë²¤íŠ¸ ë°”ì¸ë”© =====
btnCheck.addEventListener("click", checkCar);
btnVoice.addEventListener("click", startVoiceOnce);
btnEnvCheck.addEventListener("click", envCheck);
btnStartSession.addEventListener("click", startMicSession);
btnStopSession.addEventListener("click", stopMicSession);
inputEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter") checkCar(); });

// ì´ˆê¸° í™˜ê²½ ì ê²€
window.addEventListener("load", envCheck);
</script>
</body>
</html>
