<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì£¼ì°¨ ì°¨ëŸ‰ í™•ì¸ê¸° - ê°œì„ íŒ</title>
<style>
/* (ê°„ë‹¨ ìŠ¤íƒ€ì¼ ë™ì¼) */
body { font-family: Arial, sans-serif; padding:20px; background:#f9fafb; text-align:center;}
input{font-size:1.6rem;padding:10px;width:170px;border-radius:8px}
button{font-size:1.2rem;padding:10px 14px;border-radius:8px;background:#2b4eff;color:#fff;border:none}
#status{margin-top:10px;font-weight:600}
table{margin:20px auto;border-collapse:collapse;width:90%;display:none}
th,td{border:1px solid #ddd;padding:12px;background:white}
</style>
</head>
<body>
<h2>ğŸ¤ ì£¼ì°¨ ì°¨ëŸ‰ í™•ì¸ê¸° (ê°œì„ íŒ)</h2>

<input id="carInput" placeholder="4ìë¦¬ ë²ˆí˜¸" />
<button id="checkBtn">ì¡°íšŒ</button>
<button id="voiceBtn">ğŸ™ï¸ ìŒì„±ìœ¼ë¡œ ì¡°íšŒ</button>
<div id="status"></div>

<table id="resultTable"><thead><tr><th>ë²ˆí˜¸</th><th>ìƒ‰ìƒ</th><th>ì°¨ì¢…</th><th>ì£¼ì°¨ìŠ¤í‹°ì»¤</th></tr></thead><tbody></tbody></table>

<script>
/* --- ë°ì´í„° (ì›ë³¸ ë³´ì¡´) --- */
const carData = [ { ë²ˆí˜¸:"0114", ì£¼ì°¨ìŠ¤í‹°ì»¤:"ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ:"í°ìƒ‰", ì°¨ì¢…:"ë ˆì´" }, /* ... ìƒëµ ... */ ];

/* --- ìš”ì†Œ --- */
const inputEl = document.getElementById('carInput');
const statusEl = document.getElementById('status');
const table = document.getElementById('resultTable');
const tbody = table.querySelector('tbody');
const checkBtn = document.getElementById('checkBtn');
const voiceBtn = document.getElementById('voiceBtn');

/* --- ì˜¤ë””ì˜¤/ë§ˆì´í¬ ìƒíƒœ --- */
let mediaStream = null; // getUserMedia stream (ê¶Œí•œì„ í•œ ë²ˆ ìš”ì²­í•˜ê³  ì¬ì‚¬ìš©)
let recognition = null;  // webkitSpeechRecognition
let audioContext = null;

/* --- ìœ í‹¸: ê²°ê³¼ ë³´ì—¬ì£¼ê¸° --- */
function showResult(d){
  tbody.innerHTML = `<tr><td>${d.ë²ˆí˜¸}</td><td>${d.ìƒ‰ìƒ}</td><td>${d.ì°¨ì¢…}</td><td>${d.ì£¼ì°¨ìŠ¤í‹°ì»¤}</td></tr>`;
  table.style.display = 'table';
  statusEl.textContent = 'âœ… ì°¨ëŸ‰ ì •ë³´ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.';
}

/* --- TTS ì¬ìƒ: ì‚¬ìš©ì ì œìŠ¤ì²˜ë¡œ audioContext resume ë³´ì¥ --- */
async function playText(text){
  // ëª¨ë°”ì¼ ë¸Œë¼ìš°ì €ëŠ” AudioContextê°€ suspend ìƒíƒœì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ë²„íŠ¼ í´ë¦­(ì‚¬ìš©ì ì œìŠ¤ì²˜)ì—ì„œ resumeì„ ë³´ì¥í•´ì•¼ í•¨.
  try {
    if(!audioContext){ audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
    if(audioContext.state === 'suspended'){ await audioContext.resume(); }
  } catch(e){ console.warn('AudioContext resume ì‹¤íŒ¨', e); }

  // ê¸°ë³¸: Web Speech API
  try {
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'ko-KR';
    speechSynthesis.cancel(); // ì´ì „ ì·¨ì†Œ
    speechSynthesis.speak(u);
  } catch(e){
    // fallback: ì„œë²„ TTSë¥¼ ì‚¬ìš©í•´ì„œ ì¬ìƒ (ì„œë²„ê°€ ìˆë‹¤ë©´)
    console.warn('speechSynthesis ì‹¤íŒ¨, fallback í•„ìš”', e);
  }
}

/* --- ì¡°íšŒ ê¸°ëŠ¥ --- */
function checkCar(){
  const num = inputEl.value.replace(/\D/g,'').padStart(4,'0');
  if(!num){ playText('ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë§ì”€í•´ì£¼ì„¸ìš”.'); statusEl.textContent='ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; return; }
  const found = carData.find(c=>c.ë²ˆí˜¸===num);
  if(found){
    showResult(found);
    playText(`${num}ë²ˆ ì°¨ëŸ‰ì€ ${found.ìƒ‰ìƒ} ${found.ì°¨ì¢…}, ì£¼ì°¨ìŠ¤í‹°ì»¤ ${found.ì£¼ì°¨ìŠ¤í‹°ì»¤} ì…ë‹ˆë‹¤.`);
  } else {
    table.style.display='none';
    statusEl.textContent = `ğŸš« ${num}ë²ˆ ì°¨ëŸ‰ ë¯¸ë“±ë¡`;
    playText(`${num}ë²ˆ ì°¨ëŸ‰ì€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`);
  }
}

/* --- ë§ˆì´í¬ ê¶Œí•œ ì´ˆê¸°í™”: ìµœì´ˆì—” ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œí•´ì„œ íŒì—…ì„ í•œ ë²ˆë§Œ ë„ì›€ --- */
async function ensureMic(){
  if(mediaStream) return mediaStream;
  try {
    // HTTPS í™˜ê²½ì—ì„œ ê¶Œí•œì„ ìš”ì²­(Chrome/Androidì—ì„œ ê¶Œí•œì´ í•œ ë²ˆë§Œ ëœ¨ë„ë¡)
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    statusEl.textContent = 'ğŸ”´ ë§ˆì´í¬ ê¶Œí•œ í—ˆìš©ë¨';
    return mediaStream;
  } catch(e){
    statusEl.textContent = 'âŒ ë§ˆì´í¬ ê¶Œí•œ í•„ìš”: ì„¤ì •ì—ì„œ í—ˆìš©í•˜ì„¸ìš”.';
    throw e;
  }
}

/* --- ìŒì„±ì¸ì‹ ì‹œì‘ (Web Speech APIë¥¼ ìš°ì„  ì‚¬ìš©í•˜ë˜, ëª¨ë°”ì¼ ë¶ˆì•ˆì • ì‹œ ì„œë²„ STTë¡œ ëŒ€ì²´ ê¶Œì¥) --- */
async function startVoice(){
  try {
    await ensureMic(); // ê¶Œí•œ í™•ë³´(í•œ ë²ˆë§Œ)
  } catch(e){ return; }

  if(!('webkitSpeechRecognition' in window)){
    alert('ë¸Œë¼ìš°ì €ê°€ Web Speech APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Chrome ê¶Œì¥)');
    return;
  }

  // ì´ë¯¸ í™œì„±í™” ë˜ì–´ ìˆìœ¼ë©´ ì¬ì§„ì… ë°©ì§€
  if(recognition) { statusEl.textContent='ì´ë¯¸ ìŒì„±ì¸ì‹ ì¤‘ì…ë‹ˆë‹¤.'; return; }

  recognition = new webkitSpeechRecognition();
  recognition.lang = 'ko-KR';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onstart = ()=> statusEl.textContent = 'ğŸ™ï¸ ë²ˆí˜¸ë¥¼ ë§ì”€í•´ì£¼ì„¸ìš”...';
  recognition.onresult = (e) => {
    const transcript = e.results[0][0].transcript;
    const num = transcript.replace(/[^0-9]/g,'');
    if(num.length>=2 && num.length<=4){
      inputEl.value = num;
      checkCar();
    } else {
      statusEl.textContent = `âš ï¸ ì¸ì‹ ì‹¤íŒ¨("${transcript}"). ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`;
      playText('ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ë§ì”€í•´ì£¼ì„¸ìš”.');
    }
  };
  recognition.onerror = (ev) => {
    console.warn('recognition error', ev);
    // not-allowed ë“± ê¶Œí•œ ì˜¤ë¥˜ ì‹œ mediaStream ìƒíƒœ í™•ì¸
    if(ev.error === 'not-allowed' || ev.error === 'service-not-allowed'){
      statusEl.textContent = 'ë§ˆì´í¬ ê¶Œí•œ ë˜ëŠ” ë³´ì•ˆ(HTTPS) ë¬¸ì œ. ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.';
      playText('ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.');
    }
    // ëª¨ë°”ì¼ì—ì„œ ìì£¼ ë°œìƒí•˜ëŠ” ëŠê¹€ì—ëŠ” ì¬ì‹œì‘ ë¡œì§ì„ ì‹ ì¤‘íˆ ì ìš©
  };
  recognition.onend = () => {
    // ëª¨ë°”ì¼ì—ì„œëŠ” onendê°€ ìì£¼ ë°œìƒ -> í•„ìš”ì‹œ ì¬ì‹œì‘í•˜ê±°ë‚˜ ì‚¬ìš©ìì—ê²Œ ë²„íŠ¼ ë…¸ì¶œ
    recognition = null;
    statusEl.textContent = 'ìŒì„± ì¸ì‹ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
  };

  recognition.start();
}

/* --- ì´ë²¤íŠ¸ ë°”ì¸ë”© --- */
checkBtn.addEventListener('click', (e)=>{ /* user gesture -> audioContext resume ê°€ëŠ¥ */ playText('ì¡°íšŒí•©ë‹ˆë‹¤.'); checkCar(); });
voiceBtn.addEventListener('click', async ()=>{ 
  try { await ensureMic(); } catch(e){ return; }
  startVoice();
});

/* --- ì…ë ¥ Enter ì²˜ë¦¬ --- */
inputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') checkCar(); });

</script>
</body>
</html>





