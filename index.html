<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì£¼ì°¨ ì°¨ëŸ‰ í™•ì¸ê¸° (ì—°ì† ìŒì„±ì¸ì‹) - ê¶Œí•œ ê°œì„ íŒ</title>
<style>
  body { font-family: "Pretendard", sans-serif; background: #f9fafb; text-align: center; padding: 20px; }
  h2 { color: #2b4eff; }
  input { font-size: 1.2em; padding: 10px; width: 200px; margin: 10px; border-radius: 10px; border: 1px solid #ccc; text-align: center; }
  button { font-size: 1.1em; padding: 10px 20px; border: none; background: #2b4eff; color: white; border-radius: 10px; margin: 4px; }
  button:active { background: #1a36b0; }
  table { margin: 20px auto; border-collapse: collapse; width: 90%; background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  th, td { border: 1px solid #ddd; padding: 10px; }
  th { background: #f1f3f6; }
  #status { margin-top: 15px; font-weight: bold; color: #333; }
  #permInfo { margin-top:8px; font-size:0.95em; color:#555; }
</style>
</head>
<body>
  <h2>ğŸ¤ ì£¼ì°¨ ì°¨ëŸ‰ í™•ì¸ê¸° (ì—°ì† ìŒì„±ì¸ì‹)</h2>

  <input type="text" id="carInput" placeholder="4ìë¦¬ ë²ˆí˜¸ ì…ë ¥">
  <button onclick="checkCar()">ì¡°íšŒ</button>
  <button id="voiceBtn" onclick="startVoice()">ğŸ™ï¸ ìŒì„±ìœ¼ë¡œ ì¡°íšŒ (ê¶Œí•œ ìš”ì²­)</button>
  <button id="stopBtn" onclick="stopVoice()" style="display:none;background:#ff5c5c;">â–  ì¤‘ì§€</button>

  <div id="status"></div>
  <div id="permInfo"></div>

  <table id="resultTable" style="display:none;">
    <thead>
      <tr><th>ë²ˆí˜¸</th><th>ìƒ‰ìƒ</th><th>ì°¨ì¢…</th><th>ì£¼ì°¨ìŠ¤í‹°ì»¤</th></tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
/* --- ê¸°ì¡´ ì°¨ëŸ‰ ë°ì´í„° (ì›ë³¸ ìœ ì§€) --- */
const carData = [
  { ë²ˆí˜¸: "0114", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ: "í°ìƒ‰", ì°¨ì¢…: "ë ˆì´ " },
  { ë²ˆí˜¸: "0136", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ: "í°ìƒ‰", ì°¨ì¢…: "C36 ì•„ìš°ë””" },
  { ë²ˆí˜¸: "0159", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ: "ë² ì´ì§€", ì°¨ì¢…: "ëª¨ë‹" },
  { ë²ˆí˜¸: "0211", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ì—†ìŒ", ìƒ‰ìƒ: "ê²€ì •ê³„ì—´", ì°¨ì¢…: "í¬ë£¨ì¦ˆ" },
  { ë²ˆí˜¸: "0227", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ: "í°ìƒ‰", ì°¨ì¢…: "K7" },
  { ë²ˆí˜¸: "0759", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ: "ì²­ìƒ‰ê³„ì—´", ì°¨ì¢…: "ì†Œë‚˜íƒ€" },
  { ë²ˆí˜¸: "0841", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ: "í°ìƒ‰", ì°¨ì¢…: "ì•„ì´ì˜¤ë‹‰" },
  { ë²ˆí˜¸: "1045", ì£¼ì°¨ìŠ¤í‹°ì»¤: "ìˆìŒ(í™©ìƒ‰)", ìƒ‰ìƒ: "ê²€ì •ê³„ì—´", ì°¨ì¢…: "G90" }
];

const inputEl = document.getElementById("carInput");
const statusEl = document.getElementById("status");
const permInfoEl = document.getElementById("permInfo");
const table = document.getElementById("resultTable");
const tbody = table.querySelector("tbody");

let recognition = null;
let micStream = null;
let permissionGranted = false;
let autoStopTimer = null; // 30ë¶„ íƒ€ì´ë¨¸

/* ì¡°íšŒ ì²˜ë¦¬ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€) */
function checkCar() {
  const num = inputEl.value.replace(/\D/g, "").padStart(4, "0");
  if (!num) {
    speak("ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë§ì”€í•´ì£¼ì„¸ìš”.");
    return;
  }
  const found = carData.find(c => c.ë²ˆí˜¸ === num);
  if (found) {
    showResult(found);
    speak(`${num}ë²ˆ ì°¨ëŸ‰ì€ ${found.ìƒ‰ìƒ} ${found.ì°¨ì¢…}, ì£¼ì°¨ìŠ¤í‹°ì»¤ ${found.ì£¼ì°¨ìŠ¤í‹°ì»¤} ì…ë‹ˆë‹¤.`);
  } else {
    statusEl.textContent = `ğŸš« ${num}ë²ˆ ì°¨ëŸ‰ì€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`;
    table.style.display = "none";
    speak(`${num}ë²ˆ ì°¨ëŸ‰ì€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`);
  }
}

function showResult(data) {
  tbody.innerHTML = `
    <tr>
      <td>${data.ë²ˆí˜¸}</td>
      <td>${data.ìƒ‰ìƒ}</td>
      <td>${data.ì°¨ì¢…}</td>
      <td>${data.ì£¼ì°¨ìŠ¤í‹°ì»¤}</td>
    </tr>`;
  table.style.display = "table";
  statusEl.textContent = "âœ… ì°¨ëŸ‰ ì •ë³´ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.";
}

function speak(text) {
  if (!("speechSynthesis" in window)) return;
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "ko-KR";
  speechSynthesis.speak(utter);
}

/* --- ê¶Œí•œ ìš”ì²­ ë° ìŒì„±ì¸ì‹ ì´ˆê¸°í™” / 30ë¶„ ìœ ì§€ ë¡œì§ --- */
function requestMicrophoneOnce() {
  // í•œ ë²ˆ getUserMediaë¡œ ê¶Œí•œì„ ìš”ì²­í•©ë‹ˆë‹¤. (ì‚¬ìš©ìê°€ í—ˆìš©í•˜ë©´ ì„¸ì…˜ë™ì•ˆ ê¶Œí•œ ìœ ì§€)
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    permInfoEl.textContent = "âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” getUserMedia(ë§ˆì´í¬) APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chrome ê¶Œì¥.";
    return Promise.reject(new Error("getUserMedia unsupported"));
  }

  // ì´ë¯¸ ê¶Œí•œì´ ìˆëŠ” ê²½ìš° ë°”ë¡œ resolve
  if (permissionGranted) return Promise.resolve(micStream);

  return navigator.mediaDevices.getUserMedia({ audio: true })
    .then(stream => {
      micStream = stream;
      permissionGranted = true;
      permInfoEl.textContent = "ğŸ”“ ë§ˆì´í¬ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤. 30ë¶„ê°„ ì¬ìš”ì²­ ì—†ì´ ì‚¬ìš©í•©ë‹ˆë‹¤.";
      // ì£¼ì˜: ì—¬ê¸°ì„œ ê³§ë°”ë¡œ íŠ¸ë™ì„ stopí•˜ë©´ ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ ê¶Œí•œì´ ì‚¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ
      // ìš°ë¦¬ëŠ” ìŠ¤íŠ¸ë¦¼ì„ ìœ ì§€í–ˆë‹¤ê°€ 30ë¶„ í›„ì— ì¤‘ì§€í•©ë‹ˆë‹¤.
      return stream;
    })
    .catch(err => {
      permInfoEl.textContent = "â›” ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ê¶Œí•œì„ í—ˆìš©í•´ì•¼ ìŒì„±ì¸ì‹ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
      throw err;
    });
}

function initRecognition() {
  if (!("webkitSpeechRecognition" in window)) {
    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í¬ë¡¬ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
    return;
  }
  if (recognition) return; // ì´ë¯¸ ì´ˆê¸°í™”ë¨

  recognition = new webkitSpeechRecognition();
  recognition.lang = "ko-KR";
  recognition.continuous = true;
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onstart = () => {
    statusEl.textContent = "ğŸ¤ ìŒì„± ì¸ì‹ ì‹œì‘ â€” ë²ˆí˜¸ë¥¼ ë§ì”€í•´ì£¼ì„¸ìš”...";
    document.getElementById("voiceBtn").style.display = "none";
    document.getElementById("stopBtn").style.display = "inline-block";
  };

  recognition.onresult = (event) => {
    const transcript = event.results[event.results.length - 1][0].transcript;
    const num = transcript.replace(/[^0-9]/g, "");
    if (num.length >= 2 && num.length <= 4) {
      inputEl.value = num;
      checkCar();
    } else {
      statusEl.textContent = `âš ï¸ "${transcript}"ì—ì„œ ë²ˆí˜¸ ì¸ì‹ ì‹¤íŒ¨. ë‹¤ì‹œ ë§ì”€í•´ì£¼ì„¸ìš”.`;
    }
  };

  recognition.onerror = (event) => {
    if (event.error === "no-speech") {
      statusEl.textContent = "âŒ ìŒì„±ì„ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤.";
    } else {
      statusEl.textContent = `âš ï¸ ì˜¤ë¥˜ ë°œìƒ: ${event.error}`;
    }
  };

  recognition.onend = () => {
    // ìë™ ì¬ì‹œì‘: permission ìƒíƒœê°€ ìœ ì§€ë˜ê³  30ë¶„ íƒ€ì´ë¨¸ê°€ ìœ íš¨í•˜ë©´ ì¬ì‹œì‘
    if (permissionGranted && autoStopTimer) {
      try {
        recognition.start();
      } catch (e) {
        // ë¸Œë¼ìš°ì € ì •ì±…ìœ¼ë¡œ ì¬ì‹œì‘ ì‹¤íŒ¨ ê°€ëŠ¥ (íŠ¹íˆ iOS)
        statusEl.textContent = "â¸ ìŒì„±ì¸ì‹ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤(ë¸Œë¼ìš°ì € ì •ì±…). ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.";
        document.getElementById("voiceBtn").style.display = "inline-block";
        document.getElementById("stopBtn").style.display = "none";
      }
    } else {
      statusEl.textContent = "â¸ ìŒì„±ì¸ì‹ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.";
      document.getElementById("voiceBtn").style.display = "inline-block";
      document.getElementById("stopBtn").style.display = "none";
    }
  };
}

/* ì‹œì‘: ê¶Œí•œìš”ì²­ -> recognition ì‹œì‘ -> 30ë¶„ íƒ€ì´ë¨¸ ì„¤ì • */
function startVoice() {
  // 1) ê¶Œí•œ ìš”ì²­ (í•œ ë²ˆ). 2) ì´ˆê¸°í™” ë° start. 3) 30ë¶„ ìë™ì¤‘ì§€ íƒ€ì´ë¨¸.
  requestMicrophoneOnce()
    .then(() => {
      initRecognition();
      try {
        recognition.start();
      } catch (e) {
        // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¼ ìˆ˜ ìˆìŒ
      }
      // 30ë¶„ ë™ì•ˆ ìœ ì§€: íƒ€ì´ë¨¸ ì´ˆê¸°í™”
      if (autoStopTimer) clearTimeout(autoStopTimer);
      autoStopTimer = setTimeout(() => {
        stopVoice(true); // íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ì¤‘ì§€
      }, 30 * 60 * 1000); // 30ë¶„ = 1,800,000 ms
    })
    .catch((err) => {
      console.warn("ë§ˆì´í¬ ê¶Œí•œ ì‹¤íŒ¨:", err);
    });
}

/* ì¤‘ì§€: recognition ì¤‘ì§€ + ë§ˆì´í¬ íŠ¸ë™ í•´ì œ + íƒ€ì´ë¨¸ ì •ë¦¬ */
function stopVoice(isAuto=false) {
  if (recognition) {
    try { recognition.onend = null; recognition.stop(); } catch (e) {}
    recognition = null;
  }
  if (micStream) {
    micStream.getTracks().forEach(t => t.stop());
    micStream = null;
  }
  permissionGranted = false;
  if (autoStopTimer) { clearTimeout(autoStopTimer); autoStopTimer = null; }
  statusEl.textContent = isAuto ? "â° 30ë¶„ì´ ì§€ë‚˜ ìŒì„±ì¸ì‹ì„ ìë™ìœ¼ë¡œ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤." : "â¸ ìŒì„±ì¸ì‹ì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.";
  permInfoEl.textContent = "ğŸ”’ ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‚¬ìš©í•˜ë ¤ë©´ ê¶Œí•œì„ í—ˆìš©í•˜ì„¸ìš”.";
  document.getElementById("voiceBtn").style.display = "inline-block";
  document.getElementById("stopBtn").style.display = "none";
}
</script>
</body>
</html>
